name: Padel Watcher

on:
  schedule:
    - cron: "*/1 * * * *"
    - cron: "0 0 1 * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest
    concurrency:
      group: padel-watcher
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # State lives on a dedicated branch so it always persists
      - name: Checkout state branch
        uses: actions/checkout@v4
        with:
          ref: padel-state
          path: .state_branch
          fetch-depth: 0
          persist-credentials: true
          clean: false

      - name: Restore state files
        run: |
          mkdir -p state
          if [ -d .state_branch/state ]; then
            cp -f .state_branch/state/* state/ 2>/dev/null || true
          fi
          ls -la state || true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install playwright==1.47.0 requests
          python -m playwright install --with-deps chromium

      - name: Run checker
        env:
          TG_TOKEN:   ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          BOT_USERNAME: "padelsniper_bot"
          SCAN_DAYS: "45"
          START_HOUR_Z: "5"
          EARLIEST_HOUR: "0"
          LATEST_HOUR: "24"
          WEEKENDS_OK: "true"
          WEEKDAYS_OK: "true"
          ACTIVITY_ID: "149A001015"
          NOTIFY_LIMIT_PER_SLOT: "2"
          MAX_SLOTS_PER_DATE_SHOWN: "8"
        run: python checker_pw.py

      - name: Upload debug screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screens
          path: debug/*.png
          if-no-files-found: ignore

      - name: Persist state to branch
        if: always()
        run: |
          mkdir -p .state_branch/state
          cp -f state/* .state_branch/state/ 2>/dev/null || true
          cd .state_branch
          git config user.name "padel-bot"
          git config user.email "padel-bot@users.noreply.github.com"
          git add state/* || true
          git commit -m "update state [skip ci]" || true
          # create branch if it doesn't exist
          git push origin HEAD:padel-state || true

  keepalive:
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 1 * *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Touch keepalive file and push
        run: |
          date +%F > .keepalive
          git config user.name "padel-bot"
          git config user.email "padel-bot@users.noreply.github.com"
          git add .keepalive || true
          git commit -m "keepalive [skip ci]" || true
          git push || true
